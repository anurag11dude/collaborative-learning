# Firebase Schema

The core design elements of the schema are:

1. The top level keys are `test`, `dev`, `demo` and `authed` where `test` and `dev` use subkeys based on the user id to create unique environments per Firebase user.  Unit tests automatically delete any data added.
2. Under the top level keys is the `portals` key with sub-keys under `portals` for each portal domain found during authentication.  There will be a special `localhost` domain used for portals when in dev mode.  All data except for user data will live under a portal domain.
4. All objects will have a version property.
5. Any objects that can be loaded as a list should contain the minimum amount of metadata to display the information on the UI with id references to larger objects.
6. All read-only write-once data (such as "publications") will be stored using Firebase storage.

## Heirarchy

```
/(dev|test|demo|authed)
  /portals
    /<escapedPortalDomain>
      /users
        {key: uid => FirebasePortalUser}
      /classes
        {key: classHash => FirebaseClass}

NOTES:

  1. escapedPortalDomain is the Firebase escaped hostname of the domain in the portal JWT. TODO: get escapedPortalDomain is Firebase JWT claims.
  2. uid is a numeric user id from the portal JWT
  3. classHash is a string from the portal JWT
```

## Interfaces and Types

```
interface FirebasePortalUser {
  version: "1.0.0"
  documentMetadata: FirebaseDocumentMetadataMap
  documents: FirebaseDocumentMap
}

interface FirebaseDocumentMetadataMap {
  [key: string]: FirebaseDocumentMetadata // key is document id generated by push to FirebaseDocumentMap
}

interface FirebaseDocumentMap {
  [key: string]: FirebaseDocument // key is generated by push
}

interface FirebaseDocumentMetadata {
  version: "1.0.0"
  creatorUID: string
  createdAt: number|object
  // TDB: serialized document model metadata
}

interface FirebaseDocument {
  version: "1.0.0"
  // TDB: serialized document model contents
}

interface FirebaseClass {
  version: "1.0.0"
  classHash: string // allow self reference
  offerings: FirebaseOfferingMap
}

interface FirebaseOfferingMap {
  [key: string]: FirebaseOffering  // key is offeringId
}

interface FirebaseOffering {
  version: "1.0.0"
  offeringId: string // allows self reference
  users: FirebaseOfferingUserMap
  groups: FirebaseOfferingGroupMap
}

interface FirebaseOfferingUserMap {
  [key: string]: FirebaseOfferingUser // key is uid
}

interface FirebaseOfferingGroupMap {
  [key: string]: FirebaseOfferingGroup // key is groupId
}

interface FirebaseOfferingUser {
  version: "1.0.0"
  uid: string // allows self reference
  sectionDocuments: FirebaseOfferingUserSectionDocumentMap
  // TDB: store ui information here?
}

interface FirebaseOfferingUserSectionDocumentMap {
  [key: string]: FirebaseOfferingUserSectionDocument // key is section index???
}

interface FirebaseOfferingUserSectionDocument {
  version: "1.0.0"
  status: "visible" | "private"
  documentId: string // firebase id of portal user document
}

interface FirebaseOfferingGroup {
  version: "1.0.0"
  groupId: string // allows self reference
  users: FirebaseOfferingGroupUserMap
}

interface FirebaseOfferingGroupUserMap {
  [key: string]: FirebaseOfferingGroupUser // key is uid
}

interface FirebaseOfferingGroupUser {
  version: "1.0.0"
  uid: string // allows self reference
  status: FirebaseOfferingGroupUserStatus
}

type FirebaseOfferingGroupUserStatus = FirebaseOfferingGroupUserConnected | FirebaseOfferingGroupUserDisconnected

export interface FirebaseOfferingGroupUserConnected {
  version: "1.0.0"
  connected: true
  connectedAt: number|object
}
export interface FirebaseOfferingGroupUserDisconnected {
  version: "1.0.0"
  connected: false
  disconnectedAt: number|object
}

```




